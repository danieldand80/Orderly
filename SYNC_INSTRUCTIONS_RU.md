# üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## ‚ú® –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ?

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Google Sheets –≤ Supabase —Å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º **4 –º–µ—Å—è—Ü–∞** –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π.

---

## üéØ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### SMART UPSERT —Å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º 4 –º–µ—Å—è—Ü–∞:

```
–ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC / 6:00 Israel):
  1. –ß–∏—Ç–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã –∏–∑ Google Sheets
  2. UPSERT –≤ Supabase:
     - –ï—Å–ª–∏ –∑–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –û–ë–ù–û–í–õ–Ø–ï–ú
     - –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –Ω–æ–≤—ã–π ‚Üí –î–û–ë–ê–í–õ–Ø–ï–ú
  3. –£–¥–∞–ª—è–µ–º –∑–∞–∫–∞–∑—ã —Å—Ç–∞—Ä—à–µ 4 –º–µ—Å—è—Ü–µ–≤
```

### –ü—Ä–∏–º–µ—Ä:

**Google Sheets (–Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ):**
```
FLY001 - –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
FLY002 - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π tracking
FLY003 - —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
```

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –î–û:**
```
FLY002 - —Å—Ç–∞—Ä—ã–π tracking
FLY003 - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
FLY999 - 5 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥
```

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ü–û–°–õ–ï:**
```
FLY001 - ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω
FLY002 - ‚úÖ –æ–±–Ω–æ–≤–ª–µ–Ω (–Ω–æ–≤—ã–π tracking)
FLY003 - ‚úÖ –æ–±–Ω–æ–≤–ª–µ–Ω (updated_at)
FLY999 - ‚ùå —É–¥–∞–ª–µ–Ω (>4 –º–µ—Å—è—Ü–∞)
```

---

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ (2 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞)

### üìã –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É –ë–î (1 –º–∏–Ω—É—Ç–∞)

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase ‚Üí **SQL Editor**
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞: `backend/database/migrations/001_add_sync_fields.sql`
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ (–Ω–∞–∂–º–∏—Ç–µ **Run**)

**–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ:**
```sql
ALTER TABLE orders ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();
CREATE INDEX IF NOT EXISTS idx_orders_updated_at ON orders(updated_at);
```

---

### üîë –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å SYNC_API_KEY –≤ Railway (2 –º–∏–Ω—É—Ç—ã)

**2.1 –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á (PowerShell):**
```powershell
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }))
```

**–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–¥—É–º–∞–π –ª—é–±—É—é –¥–ª–∏–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É:**
```
SYNC_API_KEY=moy_sekretny_klyuch_dla_sync_12345
```

**2.2 –î–æ–±–∞–≤–∏—Ç—å –≤ Railway:**
1. Railway ‚Üí **Variables** ‚Üí **New Variable**
2. `SYNC_API_KEY` = –≤–∞—à_–∫–ª—é—á
3. **Add**

---

‚úÖ **–ì–æ—Ç–æ–≤–æ!** –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC (6:00 Israel).

### ‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å—Ç—Ä–æ–µ–Ω–∞!

Cron Job —Ä–∞–±–æ—Ç–∞–µ—Ç **–≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (–Ω–µ –Ω—É–∂–Ω—ã –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã):
- ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 AM UTC
- ‚úÖ –õ–æ–≥–∏ –≤–∏–¥–Ω—ã –ø—Ä—è–º–æ –≤ Railway
- ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫!

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (Manual Sync)

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:

**PowerShell:**
```powershell
$headers = @{ "x-api-key" = "–≤–∞—à_SYNC_API_KEY" }
Invoke-RestMethod -Uri "https://your-app.up.railway.app/api/sync-orders" -Method POST -Headers $headers
```

**Bash:**
```bash
curl -X POST https://your-app.up.railway.app/api/sync-orders \
  -H "x-api-key: –≤–∞—à_SYNC_API_KEY"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "status": "success",
  "stats": {
    "fetched": 150,
    "processed": 150,
    "errors": 0,
    "deleted": 5,
    "duration": "3.45s"
  }
}
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:

```sql
-- –í Supabase SQL Editor:
SELECT order_id, updated_at 
FROM orders 
ORDER BY updated_at DESC 
LIMIT 10;
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ Railway:

```
üîÑ ===== STARTING ORDER SYNCHRONIZATION =====
üìä Fetching orders from Google Sheets...
‚úÖ Found 150 rows
üíæ Upserting 150 orders to Supabase...
‚úÖ Upsert complete: 150 processed, 0 errors
üßπ Cleaning up old orders (>4 months)...
‚úÖ Deleted 5 old orders
‚úÖ ===== SYNCHRONIZATION COMPLETE =====
```

---

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
backend/
‚îú‚îÄ‚îÄ utils/syncOrders.js              ‚Üê –õ–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ database/migrations/
‚îÇ   ‚îî‚îÄ‚îÄ 001_add_sync_fields.sql      ‚Üê SQL –º–∏–≥—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ SYNC_SETUP.md                    ‚Üê –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ RAILWAY_CRON_SETUP.md            ‚Üê –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ Cron Job

SYNC_INSTRUCTIONS_RU.md              ‚Üê –≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Endpoint –∑–∞—â–∏—â–µ–Ω API –∫–ª—é—á–æ–º
- ‚úÖ Railway Cron –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –õ–æ–≥–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç API –∫–ª—é—á

---

## üêõ –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### "Unauthorized - Invalid API key"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `SYNC_API_KEY` –≤ Railway Variables

### "Unable to parse range"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `"Flylink Data Global"` (—Å –ø—Ä–æ–±–µ–ª–∞–º–∏)

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Cron Job Status (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Active)

---

## üìñ –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** `backend/SYNC_SETUP.md`
- **Railway Cron:** `backend/RAILWAY_CRON_SETUP.md`

---

## ‚úÖ –ß—Ç–æ –¥–∞–ª—å—à–µ?

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –Ω–∞ Railway:
1. ‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å `SYNC_API_KEY` –≤ Railway
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å Cron Job
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å manual sync
5. ‚úÖ –î–æ–∂–¥–∞—Ç—å—Å—è –ø–µ—Ä–≤–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (3:00 UTC)

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!** üéâ

---

## üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –±–µ–∑ –≤–∞—à–µ–≥–æ —É—á–∞—Å—Ç–∏—è
- ‚úÖ **–•—Ä–∞–Ω–µ–Ω–∏–µ 4 –º–µ—Å—è—Ü–∞** - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞** - —Å—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ **UPSERT –ª–æ–≥–∏–∫–∞** - –Ω–µ —Ç–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ, —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º
- ‚úÖ **Manual trigger** - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
- ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏** - –ø–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞

---

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, —Å–º–æ—Ç—Ä–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `backend/SYNC_SETUP.md`! üöÄ

